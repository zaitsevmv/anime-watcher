{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    let lastTimestamp = 0;  // Track the last received message timestamp

    function fetchMessages() {
        fetch(`/get_messages?after=${lastTimestamp}`)
            .then(response => response.json())
            .then(messages => {
                if (messages.length > 0) {
                    messages.forEach(msgStr => {
                        let msg = JSON.parse(msgStr);
                        console.log(msg.user_id);
                        console.log(msg.message);
                        console.log(msg.timestamp_ms);
                        document.getElementById('messages').innerHTML += `<p><b>User ${msg.user_id}:</b> ${msg.message}</p>`;
                        lastTimestamp = msg.timestamp_ms;  // Update the last timestamp
                    });
                }
            })
            .catch(error => console.error("Error fetching messages:", error));
    }

    function sendMessage() {
        let message = document.getElementById('message-input').value;
        fetch('/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('message-input').value = '';
                    fetchMessages();  // Fetch immediately after sending
                } else {
                    alert("Message not sent: " + data.error);
                }
            });
    }

    // Poll new messages every 2 seconds
    setInterval(fetchMessages, 2000);
</script>
{% endblock %}