{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    let lastTimestamp = 0;  // Track the last received message timestamp

    function fetchMessages() {
        fetch(`/get_messages?after=${lastTimestamp}`)
            .then(response => response.json())
            .then(messages => {
                let messagesContainer = document.getElementById('messages');
                if (messages.length > 0) {
                    messages.forEach(msg => {
                        messagesContainer.insertAdjacentHTML('afterbegin', `<p><b>${msg.user_name}:</b> ${msg.message}</p>`);
                        lastTimestamp = msg.timestamp_ms;  // Update the last timestamp
                    });
                }
            })
            .catch(error => console.error("Error fetching messages:", error));
    }

    function sendMessage() {
        let message = document.getElementById('message-input').value;
        fetch('/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('message-input').value = '';
                    fetchMessages(); 
                } else {
                    alert("Message not sent: " + data.error);
                }
            });
    }

    document.getElementById("message-input").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault(); 
            sendMessage();
        }
    });

    fetchMessages()
    setInterval(fetchMessages, 2000);
</script>
{% endblock %}