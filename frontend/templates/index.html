{% extends "base.html" %}

{% block content %}
<section class="video-container">
    <div class="video-container" id="featured-anime"></div>
</section>

<section class="search-container">
    <div id="favourite-text" class="anime-grid"></div>
    <div id="anime-results" class="anime-grid" role="list"></div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const animeIds = JSON.parse('{{ anime_ids| tojson | safe}}');

    const resultsContainer = document.getElementById('anime-results');
    const featuredContainer = document.getElementById('featured-anime');
    const favouriteTextContainer = document.getElementById('favourite-text');

    if (!animeIds || animeIds.length === 0) {
        favouriteTextContainer.innerHTML = "<p><h2>You have no favourite anime!</h2></p>";
        return;
    } else {
        favouriteTextContainer.innerHTML = "<p><h2>Favourite anime</h2></p>";
    }

    let featuredRendered = false;

    const fetchAnimeDetails = async (animeIds) => {
        try {
            const last_video = '{{ last_watched }}'

            const response = await fetch(`/anime_by_video/${last_video}`);
            const video_data = await response.json();

            if (video_data.title) {
                featuredContainer.innerHTML = `
                    <h1>${video_data.title} - ep.${video_data.episode}</h1>
                    <video width="1100" controls>
                        <source src="/videos/${last_video}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                `;
            }

            if(animeIds){
                favouriteTextContainer.innerHTML = `
                    <h2>Favourite anime</h2>
                `;
            }

            for (let animeId of animeIds) {
                const response = await fetch(`/anime_details/${animeId}`);
                
                const anime = await response.json();
                const animeCard = document.createElement('a');
                console.log(anime)
                animeCard.href = `/anime/${anime._id.$oid}`;
                animeCard.classList.add('anime-card');
                animeCard.innerHTML = `
                        <img src="${anime.image_url}" alt="${anime.title}">
                        <h3>${anime.title}</h3>
                        <p>${anime.description}</p>
                    `;
                resultsContainer.appendChild(animeCard);
            }
            console.log('All fetch requests completed.');
        } catch (error) {
            console.error('Error fetching anime details:', error);
        }
    };

    fetchAnimeDetails(animeIds);

});
</script>
{% endblock %}